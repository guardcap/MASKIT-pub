<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <title>Approver Review í…ŒìŠ¤íŠ¸</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1400px;
      margin: 20px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .test-section {
      background: white;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    button {
      padding: 10px 20px;
      margin: 5px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    button:hover {
      opacity: 0.9;
    }
    pre {
      background: #f5f5f5;
      padding: 15px;
      border-radius: 5px;
      overflow-x: auto;
      font-size: 12px;
    }
    .result {
      margin-top: 10px;
      padding: 15px;
      background: #e8f5e9;
      border-radius: 5px;
    }
    .error {
      background: #ffebee;
      color: #c62828;
    }
  </style>
</head>
<body>
  <h1>ğŸ“§ Approver Review í˜ì´ì§€ í…ŒìŠ¤íŠ¸</h1>

  <div class="test-section">
    <h2>Step 1: localStorageì— ì´ë©”ì¼ ë°ì´í„° ì €ì¥</h2>
    <p>write-email.htmlì—ì„œ ë³´ë‚¸ ê²ƒì²˜ëŸ¼ ì´ë©”ì¼ ë°ì´í„°ë¥¼ localStorageì— ì €ì¥í•©ë‹ˆë‹¤.</p>
    <button onclick="step1_saveEmailData()">ì´ë©”ì¼ ë°ì´í„° ì €ì¥</button>
    <div id="step1Result"></div>
  </div>

  <div class="test-section">
    <h2>Step 2: approver-review.html ì—´ê¸°</h2>
    <p>ì‹¤ì œ approver-review.html í˜ì´ì§€ë¥¼ ìƒˆ íƒ­ì—ì„œ ì—½ë‹ˆë‹¤.</p>
    <button onclick="step2_openApproverPage()">Approver Review í˜ì´ì§€ ì—´ê¸°</button>
    <div id="step2Result"></div>
  </div>

  <div class="test-section">
    <h2>Step 3: RAG ë¶„ì„ API ì§ì ‘ í…ŒìŠ¤íŠ¸</h2>
    <p>ë°±ì—”ë“œ APIë¥¼ ì§ì ‘ í˜¸ì¶œí•˜ì—¬ ì‘ë‹µì„ í™•ì¸í•©ë‹ˆë‹¤.</p>
    <button onclick="step3_testRAGAPI()">RAG API í…ŒìŠ¤íŠ¸</button>
    <div id="step3Result"></div>
  </div>

  <script>
    const API_BASE = 'http://127.0.0.1:8000';

    // Step 1: ì´ë©”ì¼ ë°ì´í„° ì €ì¥
    function step1_saveEmailData() {
      const emailData = {
        from: 'admin@company.com',
        to: 'partner@external.com',
        subject: 'ì‹ ê·œ ê³ ê° ê³„ì•½ ì •ë³´ ì „ë‹¬',
        body: `ì•ˆë…•í•˜ì„¸ìš”,

ì‹ ê·œ ê³ ê° ê³„ì•½ ê±´ìœ¼ë¡œ ì—°ë½ë“œë¦½ë‹ˆë‹¤.

ê³ ê° ì •ë³´:
- ì´ë¦„: í™ê¸¸ë™
- ì´ë©”ì¼: hong@customer.com
- ì „í™”ë²ˆí˜¸: 010-1234-5678
- ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸: 850101-1234567
- ê³„ì¢Œë²ˆí˜¸: 110-123-456789

ìœ„ ì •ë³´ë¡œ ê³„ì•½ì„œ ì‘ì„± ë¶€íƒë“œë¦½ë‹ˆë‹¤.

ê°ì‚¬í•©ë‹ˆë‹¤.`,
        timestamp: new Date().toISOString()
      };

      localStorage.setItem('draft_email', JSON.stringify(emailData));

      document.getElementById('step1Result').innerHTML = `
        <div class="result">
          âœ… localStorageì— ì €ì¥ ì™„ë£Œ<br>
          <pre>${JSON.stringify(emailData, null, 2)}</pre>
        </div>
      `;
    }

    // Step 2: approver-review.html ì—´ê¸°
    function step2_openApproverPage() {
      window.open('/Users/6kiity/Documents/enterprise-guardcap/frontend/pages/approver-review.html', '_blank');

      document.getElementById('step2Result').innerHTML = `
        <div class="result">
          âœ… ìƒˆ íƒ­ì—ì„œ approver-review.html ì—´ë¦¼<br>
          í˜ì´ì§€ì—ì„œ ë‹¤ìŒì„ í™•ì¸í•˜ì„¸ìš”:<br>
          1. ì´ë©”ì¼ ë³¸ë¬¸ì´ í‘œì‹œë˜ëŠ”ì§€<br>
          2. PIIê°€ ìë™ íƒì§€ë˜ëŠ”ì§€<br>
          3. ì»¤ìŠ¤í…€ ì„ íƒ í›„ "ì™„ë£Œ" ë²„íŠ¼ í´ë¦­<br>
          4. ë§ˆìŠ¤í‚¹ ë¦¬ìŠ¤íŠ¸ì— reasoningì´ í‘œì‹œë˜ëŠ”ì§€
        </div>
      `;
    }

    // Step 3: RAG API í…ŒìŠ¤íŠ¸
    async function step3_testRAGAPI() {
      const resultDiv = document.getElementById('step3Result');
      resultDiv.innerHTML = '<div class="result">â³ API í˜¸ì¶œ ì¤‘...</div>';

      try {
        const response = await fetch(`${API_BASE}/api/vectordb/analyze`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            email_body: 'ê³ ê° ì •ë³´: hong@customer.com, 010-1234-5678, 850101-1234567',
            email_subject: 'ê³ ê° ê³„ì•½ ì •ë³´',
            context: {
              sender_type: 'internal',
              receiver_type: 'external',
              purpose: ['contract'],
              regulations: ['PIPA']
            },
            detected_pii: [
              { type: 'email', value: 'hong@customer.com' },
              { type: 'phone', value: '010-1234-5678' },
              { type: 'jumin', value: '850101-1234567' }
            ],
            query: 'ì™¸ë¶€ ê³ ê°ì—ê²Œ ì´ë©”ì¼ì„ ë³´ë‚¼ ë•Œ ê°œì¸ì •ë³´ ë§ˆìŠ¤í‚¹ ê·œì •'
          })
        });

        if (!response.ok) {
          throw new Error(`API ì˜¤ë¥˜: ${response.status}`);
        }

        const result = await response.json();

        let html = '<div class="result">âœ… API ì‘ë‹µ ì„±ê³µ<br><br>';

        // ë§ˆìŠ¤í‚¹ ê²°ì • í‘œì‹œ
        if (result.success && result.data.masking_decisions) {
          html += '<strong>ğŸ“‹ ë§ˆìŠ¤í‚¹ ê²°ì •:</strong><br>';

          for (const [id, decision] of Object.entries(result.data.masking_decisions)) {
            html += `<div style="margin: 15px 0; padding: 10px; background: #f9f9f9; border-radius: 5px;">`;
            html += `<strong>${decision.type}</strong>: ${decision.value}<br>`;
            html += `ë§ˆìŠ¤í‚¹: ${decision.should_mask ? 'âœ… í•„ìš”' : 'âŒ ë¶ˆí•„ìš”'}<br>`;
            if (decision.masked_value) {
              html += `ë¯¸ë¦¬ë³´ê¸°: ${decision.masked_value}<br>`;
            }
            html += `ì´ìœ : ${decision.reason}<br>`;

            if (decision.reasoning) {
              html += `<details style="margin-top: 8px;">`;
              html += `<summary style="cursor: pointer;">ğŸ“‹ ìƒì„¸ ì¶”ë¡  ê³¼ì • ë³´ê¸°</summary>`;
              html += `<pre style="margin-top: 8px; font-size: 11px;">${decision.reasoning}</pre>`;
              html += `</details>`;
            }

            if (decision.cited_guidelines && decision.cited_guidelines.length > 0) {
              html += `<div style="margin-top: 8px; padding: 8px; background: #e3f2fd; border-radius: 4px;">`;
              html += `<strong>ğŸ“š ì¸ìš© ë²•ë ¹:</strong><br>`;
              decision.cited_guidelines.forEach(g => {
                html += `&nbsp;&nbsp;â€¢ ${g}<br>`;
              });
              html += `</div>`;
            }

            html += `</div>`;
          }
        }

        html += '<br><strong>ì „ì²´ ì‘ë‹µ:</strong>';
        html += `<pre>${JSON.stringify(result, null, 2)}</pre>`;
        html += '</div>';

        resultDiv.innerHTML = html;

      } catch (error) {
        resultDiv.innerHTML = `
          <div class="result error">
            âŒ API í˜¸ì¶œ ì‹¤íŒ¨: ${error.message}
          </div>
        `;
      }
    }
  </script>
</body>
</html>
