<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <title>ì´ë©”ì¼ ë§ˆìŠ¤í‚¹ í”Œë¡œìš° í…ŒìŠ¤íŠ¸</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; }
    .step { background: #f0f0f0; padding: 20px; margin: 20px 0; border-radius: 8px; }
    .step h3 { margin-top: 0; color: #333; }
    button { padding: 10px 20px; margin: 5px; cursor: pointer; background: #667eea; color: white; border: none; border-radius: 5px; }
    button:hover { opacity: 0.9; }
    .result { background: white; padding: 15px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px; }
    .pii-item { padding: 10px; margin: 5px 0; background: #fff3cd; border-left: 4px solid #ff9800; }
    .masked { background: #d4edda; border-left-color: #28a745; }
  </style>
</head>
<body>
  <h1>ğŸ“§ ì´ë©”ì¼ ë§ˆìŠ¤í‚¹ í”Œë¡œìš° í…ŒìŠ¤íŠ¸</h1>

  <!-- Step 1: ì´ë©”ì¼ ì‘ì„± -->
  <div class="step">
    <h3>Step 1: ì´ë©”ì¼ ì‘ì„±</h3>
    <div>
      <label>ë³´ë‚¸ì‚¬ëŒ: <input type="text" id="from" value="admin@company.com" style="width: 300px;"></label><br><br>
      <label>ë°›ëŠ”ì‚¬ëŒ: <input type="text" id="to" value="partner@external.com" style="width: 300px;"></label><br><br>
      <label>ì œëª©: <input type="text" id="subject" value="ì‹ ê·œ ê³ ê° ê³„ì•½ ì •ë³´ ì „ë‹¬" style="width: 300px;"></label><br><br>
      <label>ë³¸ë¬¸:</label><br>
      <textarea id="body" rows="10" style="width: 100%; padding: 10px;">ì•ˆë…•í•˜ì„¸ìš”,

ì‹ ê·œ ê³ ê° ê³„ì•½ ê±´ìœ¼ë¡œ ì—°ë½ë“œë¦½ë‹ˆë‹¤.

ê³ ê° ì •ë³´:
- ì´ë¦„: í™ê¸¸ë™
- ì´ë©”ì¼: hong@customer.com
- ì „í™”ë²ˆí˜¸: 010-1234-5678
- ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸: 850101-1234567
- ê³„ì¢Œë²ˆí˜¸: 110-123-456789

ìœ„ ì •ë³´ë¡œ ê³„ì•½ì„œ ì‘ì„± ë¶€íƒë“œë¦½ë‹ˆë‹¤.

ê°ì‚¬í•©ë‹ˆë‹¤.</textarea>
    </div>
    <button onclick="step1_saveEmail()">âœ… ì €ì¥ í›„ ë§ˆìŠ¤í‚¹ í˜ì´ì§€ë¡œ ì´ë™</button>
  </div>

  <!-- Step 2: PII íƒì§€ -->
  <div class="step">
    <h3>Step 2: PII ìë™ íƒì§€</h3>
    <div id="detectedPII"></div>
    <button onclick="step2_detectPII()">ğŸ” PII íƒì§€ ì‹¤í–‰</button>
  </div>

  <!-- Step 3: ì»¨í…ìŠ¤íŠ¸ ì„ íƒ -->
  <div class="step">
    <h3>Step 3: ì»¨í…ìŠ¤íŠ¸ ì„ íƒ</h3>
    <label>
      <input type="radio" name="context" value="internal" checked> ë‚´ë¶€ ì „ì†¡
    </label>
    <label style="margin-left: 20px;">
      <input type="radio" name="context" value="external"> ì™¸ë¶€ ì „ì†¡
    </label>
    <br><br>
    <button onclick="step3_analyzeWithRAG()">ğŸ¤– RAG ë¶„ì„ ì‹¤í–‰</button>
  </div>

  <!-- Step 4: ë§ˆìŠ¤í‚¹ ê²°ì • -->
  <div class="step">
    <h3>Step 4: ë§ˆìŠ¤í‚¹ ê²°ì • (LLM ìë™ ì„ íƒ)</h3>
    <div id="maskingDecisions"></div>
  </div>

  <!-- Step 5: ìµœì¢… ì´ë©”ì¼ -->
  <div class="step">
    <h3>Step 5: ë§ˆìŠ¤í‚¹ ì ìš© ê²°ê³¼</h3>
    <div id="finalEmail" class="result"></div>
    <button onclick="step5_showMaskedEmail()">ğŸ“§ ë§ˆìŠ¤í‚¹ëœ ì´ë©”ì¼ ë³´ê¸°</button>
  </div>

  <script>
    const API_BASE = 'http://127.0.0.1:8000';
    let emailData = {};
    let detectedPII = [];
    let maskingDecisions = {};

    // Step 1: ì´ë©”ì¼ ì €ì¥
    function step1_saveEmail() {
      emailData = {
        from: document.getElementById('from').value,
        to: document.getElementById('to').value,
        subject: document.getElementById('subject').value,
        body: document.getElementById('body').value
      };

      localStorage.setItem('draft_email', JSON.stringify(emailData));
      alert('âœ… ì´ë©”ì¼ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! Step 2ë¡œ ì§„í–‰í•˜ì„¸ìš”.');

      // PII ìë™ íƒì§€
      step2_detectPII();
    }

    // Step 2: PII íƒì§€
    function step2_detectPII() {
      if (!emailData.body) {
        emailData = JSON.parse(localStorage.getItem('draft_email') || '{}');
      }

      const body = emailData.body || '';
      const text = body.replace(/<[^>]*>/g, ' ');

      const patterns = {
        email: /\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b/g,
        phone: /\b\d{2,3}-\d{3,4}-\d{4}\b/g,
        jumin: /\b\d{6}-\d{7}\b/g,
        account: /\b\d{3}-\d{2,6}-\d{2,6}\b/g
      };

      detectedPII = [];

      for (const [type, pattern] of Object.entries(patterns)) {
        const matches = text.match(pattern);
        if (matches) {
          matches.forEach(match => {
            detectedPII.push({ type, value: match });
          });
        }
      }

      const typeNames = {
        email: 'ì´ë©”ì¼',
        phone: 'ì „í™”ë²ˆí˜¸',
        jumin: 'ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸',
        account: 'ê³„ì¢Œë²ˆí˜¸'
      };

      let html = `<p>íƒì§€ëœ PII: ${detectedPII.length}ê°œ</p>`;
      detectedPII.forEach((pii, idx) => {
        html += `<div class="pii-item">
          <strong>${typeNames[pii.type]}</strong>: ${pii.value}
        </div>`;
      });

      document.getElementById('detectedPII').innerHTML = html;
      console.log('íƒì§€ëœ PII:', detectedPII);
    }

    // Step 3: RAG ë¶„ì„
    async function step3_analyzeWithRAG() {
      const contextType = document.querySelector('input[name="context"]:checked').value;

      const context = {
        sender_type: 'internal',
        receiver_type: contextType,
        purpose: [],
        regulations: []
      };

      const query = contextType === 'external'
        ? 'ì™¸ë¶€ ê³ ê°ì—ê²Œ ì´ë©”ì¼ì„ ë³´ë‚¼ ë•Œ ê°œì¸ì •ë³´ ë§ˆìŠ¤í‚¹ ê·œì •'
        : 'ë‚´ë¶€ ì§ì› ê°„ ì´ë©”ì¼ì—ì„œ ê°œì¸ì •ë³´ ë§ˆìŠ¤í‚¹ ê·œì •';

      console.log('ğŸ”„ RAG ë¶„ì„ ì‹œì‘...');

      try {
        const response = await fetch(`${API_BASE}/api/vectordb/analyze`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            email_body: emailData.body,
            email_subject: emailData.subject,
            context: context,
            detected_pii: detectedPII,
            query: query
          })
        });

        if (!response.ok) {
          throw new Error('API ì‹¤íŒ¨');
        }

        const result = await response.json();
        console.log('âœ… RAG ë¶„ì„ ì™„ë£Œ:', result);

        if (result.success && result.data) {
          maskingDecisions = result.data.masking_decisions || {};
          displayMaskingDecisions(result.data);
        }

      } catch (error) {
        console.warn('âš ï¸ RAG API ì‹¤íŒ¨, Fallback ì‚¬ìš©:', error.message);

        // Fallback: ê°„ë‹¨í•œ ê·œì¹™
        maskingDecisions = {};
        detectedPII.forEach((pii, idx) => {
          const should_mask = contextType === 'external' || ['jumin', 'account'].includes(pii.type);
          maskingDecisions[`pii_${idx}`] = {
            type: pii.type,
            value: pii.value,
            should_mask: should_mask,
            reason: should_mask ? 'ì™¸ë¶€ ì „ì†¡ ë˜ëŠ” ë¯¼ê°ì •ë³´' : 'ë‚´ë¶€ ì „ì†¡'
          };
        });

        displayMaskingDecisions({
          summary: `ê¸°ë³¸ ê·œì¹™: ${contextType === 'external' ? 'ì™¸ë¶€' : 'ë‚´ë¶€'} ì „ì†¡`,
          masking_decisions: maskingDecisions
        });
      }
    }

    // ë§ˆìŠ¤í‚¹ ê²°ì • í‘œì‹œ
    function displayMaskingDecisions(data) {
      const typeNames = {
        email: 'ì´ë©”ì¼',
        phone: 'ì „í™”ë²ˆí˜¸',
        jumin: 'ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸',
        account: 'ê³„ì¢Œë²ˆí˜¸'
      };

      let html = `<p><strong>ğŸ¤– AI ë¶„ì„:</strong> ${data.summary}</p>`;
      html += '<hr>';

      for (const [id, decision] of Object.entries(data.masking_decisions || {})) {
        const className = decision.should_mask ? 'masked' : '';
        const status = decision.should_mask ? 'âœ… ë§ˆìŠ¤í‚¹ í•„ìš”' : 'âŒ ë§ˆìŠ¤í‚¹ ë¶ˆí•„ìš”';

        html += `<div class="pii-item ${className}">
          <strong>${typeNames[decision.type]}</strong>: ${decision.value}<br>
          <small>${status} - ${decision.reason}</small>
        </div>`;
      }

      document.getElementById('maskingDecisions').innerHTML = html;
    }

    // Step 5: ë§ˆìŠ¤í‚¹ëœ ì´ë©”ì¼ í‘œì‹œ
    function step5_showMaskedEmail() {
      let maskedBody = emailData.body;

      for (const decision of Object.values(maskingDecisions)) {
        if (decision.should_mask) {
          const masked = maskValue(decision.value, decision.type);
          maskedBody = maskedBody.replace(new RegExp(decision.value.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&'), 'g'), masked);
        }
      }

      const html = `
        <h4>ì›ë³¸:</h4>
        <pre style="background: #f5f5f5; padding: 15px; border-radius: 5px;">${emailData.body}</pre>

        <h4>ë§ˆìŠ¤í‚¹ ì ìš©:</h4>
        <pre style="background: #d4edda; padding: 15px; border-radius: 5px;">${maskedBody}</pre>
      `;

      document.getElementById('finalEmail').innerHTML = html;
    }

    // ë§ˆìŠ¤í‚¹ í•¨ìˆ˜
    function maskValue(value, type) {
      if (type === 'email') {
        const parts = value.split('@');
        if (parts.length === 2) {
          const masked = parts[0].substring(0, 2) + '***';
          return masked + '@' + parts[1];
        }
      } else if (type === 'phone') {
        return value.replace(/\d(?=\d{4})/g, '*');
      } else if (type === 'jumin') {
        return value.substring(0, 6) + '-*******';
      } else if (type === 'account') {
        const parts = value.split('-');
        return parts[0] + '-' + '*'.repeat(parts[1]?.length || 4) + '-' + parts[2];
      }
      return '***';
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
    window.onload = function() {
      const draft = localStorage.getItem('draft_email');
      if (draft) {
        const data = JSON.parse(draft);
        document.getElementById('from').value = data.from || '';
        document.getElementById('to').value = data.to || '';
        document.getElementById('subject').value = data.subject || '';
        document.getElementById('body').value = data.body || '';

        emailData = data;
        step2_detectPII();
      }
    };
  </script>
</body>
</html>
