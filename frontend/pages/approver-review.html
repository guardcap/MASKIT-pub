<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MASKIT - ìŠ¹ì¸ì ê²€í† </title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../style.css">
</head>
<body>
  <div class="app">
    <aside class="custombar" id="custombar">
      <div class="sb-head">
        <div class="sb-title">ì»¤ìŠ¤í…€</div>
      </div>

      
      <div class="group" id="group-inside">
        <button class="group-toggle" aria-expanded="false">
          <span>ì‚¬ë‚´</span>
          <svg class="caret" viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" fill="none" stroke-width="2"><polyline points="8 4 16 12 8 20" /></svg>
        </button>
        <ul class="items">
          <li class="item">
            <button class="checkbox off" aria-checked="false" title="ì„ íƒ" data-check></button>
            <span class="txt">ì¸ì‚¬íŒ€(HR)</span>
          </li>
          <li class="item">
            <button class="checkbox off" aria-checked="false" title="ì„ íƒ" data-check></button>
            <span class="txt">ê³ ê°ì§€ì›íŒ€(CS)</span>
          </li>
          <li class="item">
            <button class="checkbox off" aria-checked="false" title="ì„ íƒ" data-check></button>
            <span class="txt">R&DíŒ€</span>
          </li>
          <li class="item">
            <button class="checkbox off" aria-checked="false" title="ì„ íƒ" data-check></button>
            <span class="txt">ëŒ€ì™¸í˜‘ë ¥íŒ€</span>
            </li>
        </ul>
      </div>

      <div class="group" id="group-outside">
        <button class="group-toggle" aria-expanded="false">
          <span>ì‚¬ì™¸</span>
          <svg class="caret" viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" fill="none" stroke-width="2"><polyline points="8 4 16 12 8 20" /></svg>
        </button>
        <ul class="items">
          <li class="item"><button class="checkbox off" aria-checked="false" title="ì„ íƒ" data-check></button>
            <span class="txt">í˜‘ë ¥ ì—…ì²´</span>
          </li>
          <li class="item"><button class="checkbox off" aria-checked="false" title="ì„ íƒ" data-check></button>
            <span class="txt">ê³ ê°ì‚¬</span>
          </li>

          <li class="item has-sub" data-sub="gov-purpose">
            <button class="checkbox off" aria-checked="false" title="ì„ íƒ" data-check></button>
              <span class="txt">ì •ë¶€ ê¸°ê´€</span>
          </li>

          <ul class="subdrop" id="gov-purpose" hidden>
            <li class="subitem">
              <button class="checkbox off" aria-checked="false" data-check></button>
              <span class="txt">ì„¸ë¬´ ì‹ ê³  / ì¬ë¬´ ë³´ê³ </span>
            </li>
            <li class="subitem">
              <button class="checkbox off" aria-checked="false" data-check></button>
              <span class="txt">ë…¸ë™Â·ê³ ìš© ê´€ë ¨ ë³´ê³ </span>
            </li>
            <li class="subitem">
              <button class="checkbox off" aria-checked="false" data-check></button>
              <span class="txt">ê°œì¸ì •ë³´Â·ë³´ì•ˆ ê·œì œ ëŒ€ì‘</span>
            </li>
            <li class="subitem">
              <button class="checkbox off" aria-checked="false" data-check></button>
              <span class="txt">ì •ë¶€ ì§€ì›ì‚¬ì—… / ê³¼ì œ ë³´ê³ </span>
        </li>
      </ul>
    </li>
  </ul>
      </div>

      <div class="group">
        <button class="group-toggle" aria-expanded="false">
          <span>ì„¸ë¶€ ì»¤ìŠ¤í…€ </span>
          <svg class="caret" viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" fill="none" stroke-width="2"><polyline points="8 4 16 12 8 20" /></svg>
        </button>
        <ul class="items">
          <li class="item"><button class="checkbox off" aria-checked="false" title="ì„ íƒ" data-check></button>
            <span class="txt">ì‚¬ë‚´ ê·œì¹™ ìš°ì„ </span>
          </li>
          <li class="item"><button class="checkbox off" aria-checked="false" title="ì„ íƒ" data-check></button>
            <span class="txt">êµ­ë‚´ ë²•ë¥  ìš°ì„ </span>
          </li>
          <li class="item"><button class="checkbox off" aria-checked="false" title="ì„ íƒ" data-check></button>
            <span class="txt">GDPR ìš°ì„ </span>
          </li>
        </ul>
      </div>

      <div class="panel-footer">
        <button class="btn edit" id="analyzeBtn">ì™„ë£Œ</button>
      </div>
  </aside>

        <header class="top-bar">
    <div class="top-bar-title">ğŸ›¡ï¸ MASKIT - ì´ë©”ì¼ ë§ˆìŠ¤í‚¹ ê²€í† </div>
    <div class="top-bar-buttons">
        <button class="top-bar-button" id="maskingCompleteBtn" style="background: #4CAF50;">
            <span>ë§ˆìŠ¤í‚¹ ì™„ë£Œ & ì „ì†¡</span>
        </button>
        <span id="userInfo" style="color: white; margin-left: 2em; font-size: 0.9em;"></span>
        <button class="top-bar-button" id="logoutBtn" style="background: rgba(255,255,255,0.2); margin-left: 1em;">
            <span>ë¡œê·¸ì•„ì›ƒ</span>
        </button>
    </div>
</header>

    <section class="panel">
      <!-- ì´ë©”ì¼ ì •ë³´ -->
      <div class="email-info" style="padding: 20px; background: white; border-radius: 8px; margin-bottom: 20px;">
        <div style="margin-bottom: 15px;">
          <strong>ë³´ë‚¸ ì‚¬ëŒ:</strong> <span id="emailFrom">-</span>
        </div>
        <div style="margin-bottom: 15px;">
          <strong>ë°›ëŠ” ì‚¬ëŒ:</strong> <span id="emailTo">-</span>
        </div>
        <div style="margin-bottom: 15px;">
          <strong>ì œëª©:</strong> <span id="emailSubject">-</span>
        </div>
        <div style="margin-bottom: 15px;">
          <strong>ì²¨ë¶€íŒŒì¼:</strong> <span id="emailAttachments">ì—†ìŒ</span>
        </div>
        <div style="margin-top: 20px;">
          <button id="toggleBodyBtn" onclick="toggleEmailBody()" style="padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer;">
            ğŸ“§ ì´ë©”ì¼ ë³¸ë¬¸ ë³´ê¸°
          </button>
        </div>
      </div>

      <!-- ì´ë©”ì¼ ë³¸ë¬¸ (í† ê¸€ ê°€ëŠ¥) -->
      <div id="emailBodyContainer" style="display: none; padding: 20px; background: white; border-radius: 8px; margin-bottom: 20px; max-height: 400px; overflow-y: auto;">
        <h4 style="margin-bottom: 15px;">ğŸ“§ ì´ë©”ì¼ ë³¸ë¬¸</h4>
        <div id="emailBody" style="line-height: 1.6; color: #333; border: 1px solid #e0e0e0; padding: 15px; border-radius: 6px; background: #fafafa;">
          ì´ë©”ì¼ ë‚´ìš©ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
        </div>
      </div>

      <!-- AI ë¶„ì„ ê²°ê³¼ -->
      <div class="row">
        <div class="grid2">
          <div class="card">
            <h4>ğŸ¤– AI ë¶„ì„ ê²°ê³¼</h4>
            <p id="aiSummary">ì»¤ìŠ¤í…€ ì„¤ì •ì„ ì„ íƒí•˜ê³  'ì™„ë£Œ' ë²„íŠ¼ì„ ëˆŒëŸ¬ AI ë¶„ì„ì„ ì‹œì‘í•˜ì„¸ìš”.</p>
          </div>
          <div class="card">
            <h4>ğŸ“Š PII íƒì§€ í†µê³„</h4>
            <div class="legend" id="piiStats">
              <div class="row"><span class="bar c1"></span><span class="t">ë¶„ì„ ëŒ€ê¸° ì¤‘...</span></div>
            </div>
          </div>
        </div>
      </div>

      <!-- ë¡œë”© í‘œì‹œ -->
      <div id="loadingIndicator" style="display: none; text-align: center; padding: 40px;">
        <div style="font-size: 24px; margin-bottom: 10px;">ğŸ”„</div>
        <div>RAG ê²€ìƒ‰ ë° ê°€ì´ë“œë¼ì¸ ë¶„ì„ ì¤‘...</div>
      </div>
    </section>

    <aside class="sidebar" id="sidebar">
      <div class="sb-head">
        <div class="sb-title">Masking List</div>
      </div>
      </aside>
  </div>

    <div id="modal" class="modal hidden">
    <div class="modal-content">
      <p>ìˆ˜ì‹ ìë¥¼ ì„ íƒí•˜ì„¸ìš”.</p>
      <button id="modalClose">í™•ì¸</button>
    </div>
  </div>


  <script src="../script.js"></script>
  <script>
    const API_BASE = 'http://127.0.0.1:8000';
    let emailData = null;
    let detectedPII = [];
    let selectedContext = {};
    let maskingDecisions = {};

    // í˜ì´ì§€ ì´ˆê¸°í™”
    document.addEventListener('DOMContentLoaded', function() {
      // ë¡œê·¸ì¸ í™•ì¸
      const token = localStorage.getItem('auth_token');
      const user = JSON.parse(localStorage.getItem('user') || 'null');

      if (!token || !user) {
        window.location.href = './login.html';
        return;
      }

      // ì‚¬ìš©ì ì •ë³´ í‘œì‹œ
      document.getElementById('userInfo').textContent = `${user.nickname} (${user.email})`;

      // ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼
      document.getElementById('logoutBtn').addEventListener('click', function() {
        localStorage.removeItem('auth_token');
        localStorage.removeItem('user');
        window.location.href = './login.html';
      });

      // ì´ë©”ì¼ ë°ì´í„° ë¡œë“œ
      loadEmailData();

      // ì™„ë£Œ ë²„íŠ¼ (RAG ë¶„ì„)
      document.getElementById('analyzeBtn').addEventListener('click', analyzeWithRAG);

      // ë§ˆìŠ¤í‚¹ ì™„ë£Œ & ì „ì†¡ ë²„íŠ¼
      document.getElementById('maskingCompleteBtn').addEventListener('click', sendMaskedEmail);
    });

    // ì´ë©”ì¼ ë°ì´í„° ë¡œë“œ
    function loadEmailData() {
      const draftEmail = localStorage.getItem('draft_email');

      if (!draftEmail) {
        alert('ì´ë©”ì¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë©”ì¼ ì‘ì„± í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.');
        window.location.href = './write-email.html';
        return;
      }

      emailData = JSON.parse(draftEmail);

      // ì´ë©”ì¼ ì •ë³´ í‘œì‹œ
      document.getElementById('emailFrom').textContent = emailData.from || '(ì—†ìŒ)';
      document.getElementById('emailTo').textContent = emailData.to || '(ì—†ìŒ)';
      document.getElementById('emailSubject').textContent = emailData.subject || '(ì œëª© ì—†ìŒ)';
      document.getElementById('emailBody').innerHTML = emailData.body || '(ë‚´ìš© ì—†ìŒ)';

      // ì²¨ë¶€íŒŒì¼ í‘œì‹œ (í˜„ì¬ëŠ” ë¯¸êµ¬í˜„)
      document.getElementById('emailAttachments').textContent = emailData.attachments?.length > 0
        ? emailData.attachments.join(', ')
        : 'ì—†ìŒ';

      // PII ìë™ íƒì§€ (í´ë¼ì´ì–¸íŠ¸ ì¸¡ ê°„ë‹¨ íƒì§€)
      detectPIIInEmail();
    }

    // ì´ë©”ì¼ ë³¸ë¬¸ í† ê¸€
    function toggleEmailBody() {
      const container = document.getElementById('emailBodyContainer');
      const btn = document.getElementById('toggleBodyBtn');

      if (container.style.display === 'none') {
        container.style.display = 'block';
        btn.textContent = 'ğŸ“§ ì´ë©”ì¼ ë³¸ë¬¸ ìˆ¨ê¸°ê¸°';
      } else {
        container.style.display = 'none';
        btn.textContent = 'ğŸ“§ ì´ë©”ì¼ ë³¸ë¬¸ ë³´ê¸°';
      }
    }

    // PII ê°„ë‹¨ íƒì§€ (ì´ë©”ì¼, ì „í™”ë²ˆí˜¸ ë“±)
    function detectPIIInEmail() {
      const body = emailData.body || '';
      const text = body.replace(/<[^>]*>/g, ' '); // HTML íƒœê·¸ ì œê±°

      const patterns = {
        email: /\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b/g,
        phone: /\b\d{2,3}-\d{3,4}-\d{4}\b/g,
        jumin: /\b\d{6}-\d{7}\b/g,
        account: /\b\d{3}-\d{2,6}-\d{2,6}\b/g
      };

      detectedPII = [];

      for (const [type, pattern] of Object.entries(patterns)) {
        const matches = text.match(pattern);
        if (matches) {
          matches.forEach(match => {
            detectedPII.push({ type, value: match });
          });
        }
      }

      updatePIIStats();
    }

    // PII í†µê³„ ì—…ë°ì´íŠ¸
    function updatePIIStats() {
      const statsDiv = document.getElementById('piiStats');

      if (detectedPII.length === 0) {
        statsDiv.innerHTML = '<div class="row"><span class="bar c1"></span><span class="t">íƒì§€ëœ PII ì—†ìŒ</span></div>';
        return;
      }

      const typeCount = {};
      detectedPII.forEach(pii => {
        typeCount[pii.type] = (typeCount[pii.type] || 0) + 1;
      });

      const typeNames = {
        email: 'ì´ë©”ì¼',
        phone: 'ì „í™”ë²ˆí˜¸',
        jumin: 'ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸',
        account: 'ê³„ì¢Œë²ˆí˜¸'
      };

      let html = '';
      for (const [type, count] of Object.entries(typeCount)) {
        html += `<div class="row"><span class="bar c1"></span><span class="t">${typeNames[type] || type}: ${count}ê°œ</span></div>`;
      }

      statsDiv.innerHTML = html;
    }

    // ì»¤ìŠ¤í…€ ì„¤ì • ìˆ˜ì§‘
    function getSelectedContext() {
      const context = {
        sender_type: null,
        receiver_type: null,
        purpose: [],
        regulations: []
      };

      // ì‚¬ë‚´/ì‚¬ì™¸ ì„ íƒ
      const insideChecked = document.querySelector('#group-inside .checkbox.on');
      const outsideChecked = document.querySelector('#group-outside .checkbox.on');

      if (insideChecked) {
        context.sender_type = 'internal';
        context.receiver_type = 'internal';
      } else if (outsideChecked) {
        context.sender_type = 'internal';
        context.receiver_type = 'external';
      }

      // ì„¸ë¶€ ëª©ì  (ì •ë¶€ ê¸°ê´€ ë“±)
      const purposeChecked = document.querySelectorAll('#gov-purpose .checkbox.on');
      purposeChecked.forEach(cb => {
        const text = cb.nextElementSibling?.textContent.trim();
        if (text) context.purpose.push(text);
      });

      // ê·œì œ ìš°ì„ ìˆœìœ„
      const regChecked = document.querySelectorAll('.group:last-child .checkbox.on');
      regChecked.forEach(cb => {
        const text = cb.nextElementSibling?.textContent.trim();
        if (text) context.regulations.push(text);
      });

      return context;
    }

    // RAG ë¶„ì„ ì‹¤í–‰
    async function analyzeWithRAG() {
      const context = getSelectedContext();

      if (!context.sender_type) {
        alert('ì‚¬ë‚´/ì‚¬ì™¸ êµ¬ë¶„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
      }

      selectedContext = context;

      // ë¡œë”© í‘œì‹œ
      document.getElementById('loadingIndicator').style.display = 'block';
      document.getElementById('aiSummary').textContent = 'ë¶„ì„ ì¤‘...';

      try {
        // RAG ì¿¼ë¦¬ ìƒì„±
        const query = buildRAGQuery();

        // API í˜¸ì¶œ
        const response = await fetch(`${API_BASE}/api/vectordb/analyze`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            email_body: emailData.body,
            email_subject: emailData.subject,
            context: context,
            detected_pii: detectedPII,
            query: query
          })
        });

        if (!response.ok) {
          throw new Error('RAG ë¶„ì„ ì‹¤íŒ¨');
        }

        const result = await response.json();

        // ë§ˆìŠ¤í‚¹ ê²°ì • ì ìš©
        if (result.success && result.data) {
          applyMaskingDecisions(result.data);
        }

      } catch (error) {
        console.error('RAG ë¶„ì„ ì˜¤ë¥˜:', error);
        document.getElementById('aiSummary').textContent = 'ë¶„ì„ ì‹¤íŒ¨: ' + error.message;

        // Fallback: ê°„ë‹¨í•œ ê·œì¹™ ê¸°ë°˜ ë§ˆìŠ¤í‚¹
        applySimpleMaskingRules();
      } finally {
        document.getElementById('loadingIndicator').style.display = 'none';
      }
    }

    // RAG ì¿¼ë¦¬ ìƒì„±
    function buildRAGQuery() {
      const context = selectedContext;
      let query = '';

      if (context.receiver_type === 'external') {
        query = 'ì™¸ë¶€ ê³ ê°ì—ê²Œ ì´ë©”ì¼ì„ ë³´ë‚¼ ë•Œ ê°œì¸ì •ë³´ ë§ˆìŠ¤í‚¹ ê·œì •';
      } else {
        query = 'ë‚´ë¶€ ì§ì› ê°„ ì´ë©”ì¼ì—ì„œ ê°œì¸ì •ë³´ ë§ˆìŠ¤í‚¹ ê·œì •';
      }

      if (context.purpose.length > 0) {
        query += ', ' + context.purpose.join(', ') + ' ê´€ë ¨';
      }

      return query;
    }

    // ë§ˆìŠ¤í‚¹ ê²°ì • ì ìš©
    function applyMaskingDecisions(data) {
      maskingDecisions = data.masking_decisions || {};

      // AI ìš”ì•½ í‘œì‹œ
      document.getElementById('aiSummary').textContent =
        data.summary || 'ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ê°€ì´ë“œë¼ì¸ì— ë”°ë¼ ë§ˆìŠ¤í‚¹ í•­ëª©ì´ ìë™ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤.';

      // ì‚¬ì´ë“œë°” ë§ˆìŠ¤í‚¹ ë¦¬ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
      updateMaskingList();
    }

    // ê°„ë‹¨í•œ ê·œì¹™ ê¸°ë°˜ ë§ˆìŠ¤í‚¹ (Fallback)
    function applySimpleMaskingRules() {
      maskingDecisions = {};

      detectedPII.forEach((pii, idx) => {
        // ì™¸ë¶€ ì „ì†¡ì´ë©´ ëª¨ë‘ ë§ˆìŠ¤í‚¹
        if (selectedContext.receiver_type === 'external') {
          maskingDecisions[`pii_${idx}`] = {
            type: pii.type,
            value: pii.value,
            should_mask: true,
            reason: 'ì™¸ë¶€ ì „ì†¡ ì‹œ ê°œì¸ì •ë³´ ë§ˆìŠ¤í‚¹ í•„ìˆ˜'
          };
        } else {
          // ì£¼ë¯¼ë²ˆí˜¸, ê³„ì¢Œë²ˆí˜¸ëŠ” í•­ìƒ ë§ˆìŠ¤í‚¹
          if (pii.type === 'jumin' || pii.type === 'account') {
            maskingDecisions[`pii_${idx}`] = {
              type: pii.type,
              value: pii.value,
              should_mask: true,
              reason: 'ë¯¼ê°ì •ë³´ ë§ˆìŠ¤í‚¹ í•„ìˆ˜'
            };
          }
        }
      });

      document.getElementById('aiSummary').textContent =
        'ê¸°ë³¸ ê·œì¹™ì— ë”°ë¼ ë§ˆìŠ¤í‚¹ í•­ëª©ì´ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤.';

      updateMaskingList();
    }

    // ë§ˆìŠ¤í‚¹ ë¦¬ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
    function updateMaskingList() {
      const sidebar = document.getElementById('sidebar');

      const typeNames = {
        email: 'ì´ë©”ì¼',
        phone: 'ì „í™”ë²ˆí˜¸',
        jumin: 'ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸',
        account: 'ê³„ì¢Œë²ˆí˜¸',
        passport: 'ì—¬ê¶Œë²ˆí˜¸',
        driver_license: 'ìš´ì „ë©´í—ˆë²ˆí˜¸'
      };

      let html = `
        <div class="sb-head">
          <div class="sb-title">Masking List</div>
        </div>
      `;

      if (Object.keys(maskingDecisions).length === 0) {
        html += '<div style="padding: 20px; color: #999;">ë§ˆìŠ¤í‚¹ í•­ëª© ì—†ìŒ</div>';
      } else {
        html += '<div style="padding: 15px; overflow-y: auto; max-height: calc(100vh - 200px);">';

        for (const [id, decision] of Object.entries(maskingDecisions)) {
          const checked = decision.should_mask ? 'on' : 'off';
          const checkedAttr = decision.should_mask ? 'true' : 'false';
          const typeName = typeNames[decision.type] || decision.type;

          // reasoning HTML ë³€í™˜
          const reasoningHtml = decision.reasoning
            ? decision.reasoning.replace(/\n/g, '<br>').replace(/   /g, '&nbsp;&nbsp;&nbsp;')
            : '';

          // cited_guidelines í‘œì‹œ
          const guidelinesHtml = decision.cited_guidelines && decision.cited_guidelines.length > 0
            ? '<div style="margin-top: 8px; padding: 8px; background: #f0f7ff; border-left: 3px solid #2196F3; border-radius: 4px;">' +
              '<div style="font-size: 10px; font-weight: 600; color: #1976D2; margin-bottom: 4px;">ğŸ“š ì¸ìš© ë²•ë ¹</div>' +
              decision.cited_guidelines.map(g => `<div style="font-size: 10px; color: #555; margin-left: 8px;">â€¢ ${g}</div>`).join('') +
              '</div>'
            : '';

          // masked_value í‘œì‹œ
          const maskedPreview = decision.masked_value
            ? `<div style="font-size: 11px; color: #28a745; margin-top: 3px;">â†’ ${decision.masked_value}</div>`
            : '';

          // risk_level ë±ƒì§€
          const riskColors = {
            high: '#dc3545',
            critical: '#dc3545',
            medium: '#ffc107',
            low: '#28a745'
          };
          const riskColor = riskColors[decision.risk_level] || '#999';
          const riskBadge = decision.risk_level
            ? `<span style="display: inline-block; padding: 2px 6px; background: ${riskColor}; color: white; font-size: 9px; border-radius: 3px; margin-left: 5px;">${decision.risk_level.toUpperCase()}</span>`
            : '';

          html += `
            <div class="group" style="margin-bottom: 20px; padding: 12px; background: ${decision.should_mask ? '#f0fff4' : '#fff'}; border-radius: 8px; border: 1px solid ${decision.should_mask ? '#28a745' : '#ddd'};">
              <div style="display: flex; align-items: start; gap: 10px;">
                <button class="checkbox ${checked}" aria-checked="${checkedAttr}"
                        data-check data-pii-id="${id}"
                        onclick="toggleMasking('${id}')"
                        style="flex-shrink: 0; margin-top: 3px;"></button>
                <div style="flex: 1;">
                  <div style="font-weight: 600; margin-bottom: 5px; color: #333;">
                    ${typeName}${riskBadge}
                  </div>
                  <div style="font-size: 12px; color: #666; margin-bottom: 5px; font-family: monospace; background: #f5f5f5; padding: 4px 8px; border-radius: 4px;">
                    ${decision.value}
                    ${maskedPreview}
                  </div>
                  <div style="font-size: 11px; color: #555; margin-bottom: 8px; font-weight: 500;">
                    ${decision.reason || ''}
                  </div>
                  ${reasoningHtml ? `
                    <details style="margin-top: 8px;">
                      <summary style="cursor: pointer; font-size: 10px; color: #666; user-select: none;">
                        ğŸ“‹ ìƒì„¸ ì¶”ë¡  ê³¼ì • ë³´ê¸°
                      </summary>
                      <div style="margin-top: 8px; padding: 10px; background: #f9f9f9; border-radius: 4px; font-size: 10px; line-height: 1.6; color: #444;">
                        ${reasoningHtml}
                      </div>
                    </details>
                  ` : ''}
                  ${guidelinesHtml}
                </div>
              </div>
            </div>
          `;
        }

        html += '</div>';
      }

      sidebar.innerHTML = html;
    }

    // ë§ˆìŠ¤í‚¹ í† ê¸€
    function toggleMasking(piiId) {
      if (maskingDecisions[piiId]) {
        maskingDecisions[piiId].should_mask = !maskingDecisions[piiId].should_mask;
        updateMaskingList();
      }
    }

    // ë§ˆìŠ¤í‚¹ ì™„ë£Œ ë° ì´ë©”ì¼ ì „ì†¡
    async function sendMaskedEmail() {
      if (!emailData) {
        alert('ì´ë©”ì¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      if (Object.keys(maskingDecisions).length === 0) {
        if (!confirm('ë§ˆìŠ¤í‚¹ ë¶„ì„ì„ ì‹¤í–‰í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ê·¸ëŒ€ë¡œ ì „ì†¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
          return;
        }
      }

      // ë§ˆìŠ¤í‚¹ ì ìš©
      let maskedBody = emailData.body;

      for (const decision of Object.values(maskingDecisions)) {
        if (decision.should_mask) {
          const masked = maskValue(decision.value, decision.type);
          maskedBody = maskedBody.replace(new RegExp(decision.value, 'g'), masked);
        }
      }

      // SMTP ì „ì†¡
      try {
        // ì „ì†¡ ì •ë³´ ë¡œê·¸
        const maskedCount = Object.values(maskingDecisions).filter(d => d.should_mask).length;
        console.log('ğŸ“§ ì´ë©”ì¼ ì „ì†¡ ì‹œì‘:', {
          from: emailData.from,
          to: emailData.to,
          subject: emailData.subject,
          maskedCount: maskedCount
        });

        // ë¡œë”© í‘œì‹œ
        const loadingEl = document.getElementById('loadingIndicator');
        if (loadingEl) {
          loadingEl.style.display = 'block';
          loadingEl.innerHTML = '<div style="font-size: 24px; margin-bottom: 10px;">ğŸ“§</div><div>ì´ë©”ì¼ ì „ì†¡ ì¤‘...</div>';
        }

        // SMTP APIë¡œ ë©”ì¼ ì „ì†¡
        const token = localStorage.getItem('auth_token');
        const response = await fetch(`${API_BASE}/api/v1/smtp/send`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            from_email: emailData.from,
            to: emailData.to,
            subject: emailData.subject,
            body: maskedBody,
            cc: null,
            bcc: null,
            attachments: null
          })
        });

        const result = await response.json();

        // ë¡œë”© ìˆ¨ê¹€
        if (loadingEl) {
          loadingEl.style.display = 'none';
        }

        if (!response.ok) {
          throw new Error(result.detail || 'ë©”ì¼ ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }

        console.log('âœ… ì „ì†¡ ì„±ê³µ:', result);

        // ì„±ê³µ ë©”ì‹œì§€
        let message = 'âœ… ì´ë©”ì¼ì´ ì„±ê³µì ìœ¼ë¡œ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤!\n\n';
        message += `ë°›ëŠ” ì‚¬ëŒ: ${emailData.to}\n`;
        message += `ì œëª©: ${emailData.subject}\n`;
        if (maskedCount > 0) {
          message += `ë§ˆìŠ¤í‚¹ ì ìš©: ${maskedCount}ê°œ í•­ëª©\n`;
        }
        message += `\nì „ì†¡ ì‹œê°„: ${new Date(result.sent_at).toLocaleString('ko-KR')}`;

        alert(message);

        // ì„ì‹œ ë°ì´í„° ì‚­ì œ
        localStorage.removeItem('draft_email');

        // ëŒ€ì‹œë³´ë“œë¡œ ì´ë™
        window.location.href = './dashboard-user.html';

      } catch (error) {
        console.error('ì „ì†¡ ì˜¤ë¥˜:', error);

        // ë¡œë”© ìˆ¨ê¹€
        const loadingEl = document.getElementById('loadingIndicator');
        if (loadingEl) {
          loadingEl.style.display = 'none';
        }

        alert('âŒ ì´ë©”ì¼ ì „ì†¡ ì‹¤íŒ¨: ' + error.message);
      }
    }

    // ê°’ ë§ˆìŠ¤í‚¹
    function maskValue(value, type) {
      if (type === 'email') {
        const parts = value.split('@');
        if (parts.length === 2) {
          const masked = parts[0].substring(0, 2) + '***';
          return masked + '@' + parts[1];
        }
      } else if (type === 'phone') {
        return value.replace(/\d(?=\d{4})/g, '*');
      } else if (type === 'jumin') {
        return value.substring(0, 6) + '-*******';
      } else if (type === 'account') {
        const parts = value.split('-');
        return parts[0] + '-' + '*'.repeat(parts[1]?.length || 4) + '-' + parts[2];
      }

      return '***';
    }

    // ì „ì—­ í•¨ìˆ˜ë¡œ ë…¸ì¶œ
    window.toggleMasking = toggleMasking;
    window.toggleEmailBody = toggleEmailBody;
  </script>
</body>
</html>