<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MASKIT - ì •ì±… ìƒì„¸ë³´ê¸°</title>
    <link rel="stylesheet" href="../common-style.css">
    <style>
        .detail-container {
            max-width: 1000px;
            margin: 0 auto;
        }

        .back-button {
            display: inline-flex;
            align-items: center;
            gap: 0.5em;
            padding: 0.8em 1.5em;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 2em;
            font-size: 1em;
            transition: all 0.3s;
        }

        .back-button:hover {
            border-color: #667eea;
            color: #667eea;
        }

        .policy-header {
            background: white;
            padding: 2em;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 2em;
        }

        .policy-title {
            font-size: 2em;
            font-weight: 600;
            color: #333;
            margin-bottom: 0.5em;
        }

        .policy-meta {
            display: flex;
            gap: 2em;
            color: #666;
            font-size: 0.95em;
            margin-bottom: 1em;
            flex-wrap: wrap;
        }

        .policy-meta-item {
            display: flex;
            align-items: center;
            gap: 0.5em;
        }

        .policy-actions {
            display: flex;
            gap: 1em;
            margin-top: 1.5em;
        }

        .btn-edit {
            padding: 0.8em 1.5em;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
        }

        .btn-delete {
            padding: 0.8em 1.5em;
            background: #f44336;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
        }

        .section {
            background: white;
            padding: 2em;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 1.5em;
        }

        .section-title {
            font-size: 1.3em;
            font-weight: 600;
            color: #333;
            margin-bottom: 1em;
            padding-bottom: 0.5em;
            border-bottom: 2px solid #f0f0f0;
        }

        .metadata-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5em;
        }

        .metadata-item {
            padding: 1em;
            background: #f9f9f9;
            border-radius: 8px;
        }

        .metadata-label {
            font-size: 0.9em;
            color: #999;
            margin-bottom: 0.3em;
        }

        .metadata-value {
            font-size: 1.1em;
            color: #333;
            font-weight: 500;
        }

        .tags-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5em;
        }

        .tag {
            background: #eef2ff;
            color: #667eea;
            padding: 0.5em 1em;
            border-radius: 999px;
            font-size: 0.9em;
        }

        .content-text {
            background: #f9f9f9;
            padding: 1.5em;
            border-radius: 8px;
            line-height: 1.8;
            color: #333;
            white-space: pre-wrap;
            max-height: 500px;
            overflow-y: auto;
        }

        .badge {
            display: inline-block;
            padding: 0.4em 0.8em;
            border-radius: 999px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .badge-pdf { background: #fee; color: #c00; }
        .badge-image { background: #efe; color: #090; }

        .loading {
            text-align: center;
            padding: 4em;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1em;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-value {
            color: #999;
            font-style: italic;
        }

        .list-container {
            padding-left: 1.5em;
        }

        .list-container li {
            margin-bottom: 0.5em;
            color: #666;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 2em;
            border-radius: 12px;
            max-width: 500px;
            text-align: center;
        }

        .modal-buttons {
            display: flex;
            gap: 1em;
            justify-content: center;
            margin-top: 1.5em;
        }
    </style>
</head>
<body>
    <div class="navbar">
        <h1>ğŸ“œ MASKIT - ì •ì±… ìƒì„¸</h1>
        <div class="user-info">
            <span id="userName"></span>
            <button onclick="location.href='../dashboard-policy.html'">ëŒ€ì‹œë³´ë“œ</button>
            <button onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
    </div>

    <div class="container detail-container">
        <button class="back-button" onclick="goBack()">
            â† ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°
        </button>

        <div id="loadingContainer" class="loading">
            <div class="spinner"></div>
            <p>ì •ì±… ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
        </div>

        <div id="policyContainer" style="display: none;">
            <!-- ì •ì±… í—¤ë” -->
            <div class="policy-header">
                <div class="policy-title" id="policyTitle"></div>
                <div class="policy-meta" id="policyMeta"></div>
                <p id="policyDescription"></p>

                <div class="policy-actions">
                    <button class="btn-delete" onclick="showDeleteModal()">ì‚­ì œ</button>
                </div>
            </div>

            <!-- ë©”íƒ€ë°ì´í„° ì„¹ì…˜ -->
            <div class="section">
                <h3 class="section-title">ğŸ“Š ì •ì±… ì •ë³´</h3>
                <div class="metadata-grid" id="metadataGrid"></div>
            </div>

            <!-- ìš”ì•½ ì„¹ì…˜ -->
            <div class="section" id="summarySection" style="display: none;">
                <h3 class="section-title">ğŸ“ ìš”ì•½</h3>
                <div id="summaryCon tent"></div>
            </div>

            <!-- í‚¤ì›Œë“œ ì„¹ì…˜ -->
            <div class="section" id="keywordsSection" style="display: none;">
                <h3 class="section-title">ğŸ·ï¸ í‚¤ì›Œë“œ</h3>
                <div class="tags-container" id="keywordsContainer"></div>
            </div>

            <!-- ì—”í‹°í‹° íƒ€ì… ì„¹ì…˜ -->
            <div class="section" id="entityTypesSection" style="display: none;">
                <h3 class="section-title">ğŸ” ê°œì¸ì •ë³´ ìœ í˜•</h3>
                <div class="tags-container" id="entityTypesContainer"></div>
            </div>

            <!-- ì‹œë‚˜ë¦¬ì˜¤ ì„¹ì…˜ -->
            <div class="section" id="scenariosSection" style="display: none;">
                <h3 class="section-title">ğŸ“‹ ì ìš© ì‹œë‚˜ë¦¬ì˜¤</h3>
                <ul class="list-container" id="scenariosContainer"></ul>
            </div>

            <!-- ì‹¤í–‰ ì§€ì¹¨ ì„¹ì…˜ -->
            <div class="section" id="directivesSection" style="display: none;">
                <h3 class="section-title">âœ… ì‹¤í–‰ ì§€ì¹¨</h3>
                <ul class="list-container" id="directivesContainer"></ul>
            </div>

            <!-- ì „ì²´ í…ìŠ¤íŠ¸ ì„¹ì…˜ -->
            <div class="section">
                <h3 class="section-title">ğŸ“„ ì¶”ì¶œëœ í…ìŠ¤íŠ¸</h3>
                <div class="content-text" id="extractedText"></div>
            </div>
        </div>
    </div>

    <!-- ì‚­ì œ í™•ì¸ ëª¨ë‹¬ -->
    <div class="modal" id="deleteModal">
        <div class="modal-content">
            <h3>ì •ì±… ì‚­ì œ</h3>
            <p>ì •ë§ë¡œ ì´ ì •ì±…ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
            <p style="color: #999; font-size: 0.9em;">ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
            <div class="modal-buttons">
                <button class="btn-secondary" onclick="closeDeleteModal()">ì·¨ì†Œ</button>
                <button class="btn-delete" onclick="confirmDelete()">ì‚­ì œ</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://127.0.0.1:8000';
        const token = localStorage.getItem('auth_token');
        const user = JSON.parse(localStorage.getItem('user') || '{}');

        // ê¶Œí•œ í™•ì¸
        if (!token || user.role !== 'policy_admin') {
            alert('ì •ì±… ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤');
            window.location.href = '../dashboard-policy.html';
        }

        document.getElementById('userName').textContent = user.nickname || user.email;

        // URLì—ì„œ policy_id ê°€ì ¸ì˜¤ê¸°
        const urlParams = new URLSearchParams(window.location.search);
        const policyId = urlParams.get('id');

        if (!policyId) {
            alert('ì •ì±… IDê°€ ì—†ìŠµë‹ˆë‹¤');
            window.location.href = 'policy-list.html';
        }

        let currentPolicy = null;

        // ì •ì±… ìƒì„¸ ì •ë³´ ë¡œë“œ
        async function loadPolicyDetail() {
            try {
                const response = await fetch(`${API_BASE}/api/policies/${policyId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    currentPolicy = result.data;
                    displayPolicy(currentPolicy);
                } else {
                    throw new Error(result.detail || 'ì •ì±…ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
                }

            } catch (error) {
                console.error('Load error:', error);
                document.getElementById('loadingContainer').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">âš ï¸</div>
                        <div class="empty-text">ì •ì±…ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤</div>
                        <p style="color: #999;">${error.message}</p>
                    </div>
                `;
            }
        }

        // ì •ì±… ì •ë³´ í‘œì‹œ
        function displayPolicy(policy) {
            // í—¤ë”
            document.getElementById('policyTitle').textContent = policy.title;

            const fileTypeBadge = policy.file_type === '.pdf'
                ? '<span class="badge badge-pdf">PDF</span>'
                : '<span class="badge badge-image">ì´ë¯¸ì§€</span>';

            document.getElementById('policyMeta').innerHTML = `
                <div class="policy-meta-item">
                    <strong>ê¸°ê´€:</strong> ${policy.authority}
                </div>
                <div class="policy-meta-item">
                    <strong>íŒŒì¼ íƒ€ì…:</strong> ${fileTypeBadge}
                </div>
                <div class="policy-meta-item">
                    <strong>íŒŒì¼ í¬ê¸°:</strong> ${policy.file_size_mb.toFixed(2)} MB
                </div>
                <div class="policy-meta-item">
                    <strong>ì²˜ë¦¬ ë°©ë²•:</strong> ${policy.processing_method}
                </div>
                <div class="policy-meta-item">
                    <strong>ìƒì„±ì¼:</strong> ${formatDateTime(policy.created_at)}
                </div>
            `;

            if (policy.description) {
                document.getElementById('policyDescription').textContent = policy.description;
            } else {
                document.getElementById('policyDescription').innerHTML = '<span class="empty-value">ì„¤ëª… ì—†ìŒ</span>';
            }

            // ë©”íƒ€ë°ì´í„° ê·¸ë¦¬ë“œ
            const metadataGrid = document.getElementById('metadataGrid');
            metadataGrid.innerHTML = `
                <div class="metadata-item">
                    <div class="metadata-label">ì •ì±… ID</div>
                    <div class="metadata-value">${policy.policy_id}</div>
                </div>
                <div class="metadata-item">
                    <div class="metadata-label">ì›ë³¸ íŒŒì¼ëª…</div>
                    <div class="metadata-value">${policy.original_filename}</div>
                </div>
                <div class="metadata-item">
                    <div class="metadata-label">ì €ì¥ëœ íŒŒì¼ëª…</div>
                    <div class="metadata-value">${policy.saved_filename}</div>
                </div>
            `;

            // ë©”íƒ€ë°ì´í„°ê°€ ìˆìœ¼ë©´ í‘œì‹œ
            if (policy.metadata) {
                const meta = policy.metadata;

                // ìš”ì•½
                if (meta.summary) {
                    document.getElementById('summarySection').style.display = 'block';
                    document.getElementById('summaryContent').innerHTML = `<p>${meta.summary}</p>`;
                }

                // í‚¤ì›Œë“œ
                if (meta.keywords && meta.keywords.length > 0) {
                    document.getElementById('keywordsSection').style.display = 'block';
                    document.getElementById('keywordsContainer').innerHTML = meta.keywords
                        .map(k => `<span class="tag">${k}</span>`)
                        .join('');
                }

                // ì—”í‹°í‹° íƒ€ì…
                if (meta.entity_types && meta.entity_types.length > 0) {
                    document.getElementById('entityTypesSection').style.display = 'block';
                    document.getElementById('entityTypesContainer').innerHTML = meta.entity_types
                        .map(e => `<span class="tag">${e}</span>`)
                        .join('');
                }

                // ì‹œë‚˜ë¦¬ì˜¤
                if (meta.scenarios && meta.scenarios.length > 0) {
                    document.getElementById('scenariosSection').style.display = 'block';
                    document.getElementById('scenariosContainer').innerHTML = meta.scenarios
                        .map(s => `<li>${s}</li>`)
                        .join('');
                }

                // ì‹¤í–‰ ì§€ì¹¨
                if (meta.directives && meta.directives.length > 0) {
                    document.getElementById('directivesSection').style.display = 'block';
                    document.getElementById('directivesContainer').innerHTML = meta.directives
                        .map(d => `<li>${d}</li>`)
                        .join('');
                }
            }

            // ì¶”ì¶œëœ í…ìŠ¤íŠ¸
            const extractedText = policy.extracted_text || 'í…ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤';
            document.getElementById('extractedText').textContent = extractedText;

            // ë¡œë”© ìˆ¨ê¸°ê³  ì»¨í…Œì´ë„ˆ í‘œì‹œ
            document.getElementById('loadingContainer').style.display = 'none';
            document.getElementById('policyContainer').style.display = 'block';
        }

        // ë‚ ì§œ í¬ë§·
        function formatDateTime(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            return date.toLocaleString('ko-KR');
        }

        // ì‚­ì œ ëª¨ë‹¬ í‘œì‹œ
        function showDeleteModal() {
            document.getElementById('deleteModal').classList.add('show');
        }

        // ì‚­ì œ ëª¨ë‹¬ ë‹«ê¸°
        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.remove('show');
        }

        // ì‚­ì œ í™•ì¸
        async function confirmDelete() {
            try {
                const response = await fetch(`${API_BASE}/api/policies/${policyId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    alert('ì •ì±…ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
                    window.location.href = 'policy-list.html';
                } else {
                    throw new Error(result.detail || 'ì •ì±… ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
                }

            } catch (error) {
                console.error('Delete error:', error);
                alert(error.message || 'ì •ì±… ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
                closeDeleteModal();
            }
        }

        // ë’¤ë¡œ ê°€ê¸°
        function goBack() {
            window.location.href = 'policy-list.html';
        }

        // ë¡œê·¸ì•„ì›ƒ
        function logout() {
            localStorage.removeItem('auth_token');
            localStorage.removeItem('user');
            window.location.href = '../login.html';
        }

        // ì´ˆê¸° ë¡œë“œ
        loadPolicyDetail();
    </script>
</body>
</html>
