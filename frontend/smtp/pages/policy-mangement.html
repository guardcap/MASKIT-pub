<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MASKIT - ì •ì±… ê´€ë¦¬</title>
    <link rel="stylesheet" href="../common-style.css">
    <style>
        .action-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5em;
        }
        
        .search-box {
            display: flex;
            gap: 0.5em;
        }
        
        .search-box input {
            padding: 0.8em;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            width: 300px;
        }
        
        .btn-add {
            padding: 0.8em 1.5em;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .btn-add:hover {
            background: #5568d3;
        }
        
        .policy-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5em;
        }
        
        .policy-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            padding: 1.5em;
            transition: transform 0.2s;
        }
        
        .policy-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }
        
        .policy-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1em;
        }
        
        .policy-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
            margin-bottom: 0.5em;
        }
        
        .policy-type {
            padding: 0.3em 0.8em;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: bold;
        }
        
        .type-dlp {
            background: #e3f2fd;
            color: #1976d2;
        }
        
        .type-approval {
            background: #fff3e0;
            color: #f57c00;
        }
        
        .type-masking {
            background: #f3e5f5;
            color: #7b1fa2;
        }
        
        .policy-description {
            color: #666;
            font-size: 0.95em;
            margin-bottom: 1em;
            line-height: 1.6;
        }
        
        .policy-meta {
            color: #999;
            font-size: 0.85em;
            border-top: 1px solid #f0f0f0;
            padding-top: 1em;
            margin-bottom: 1em;
        }
        
        .policy-actions {
            display: flex;
            gap: 0.5em;
        }
        
        .btn-edit, .btn-delete {
            padding: 0.6em 1em;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: bold;
        }
        
        .btn-edit {
            background: #667eea;
            color: white;
            flex: 1;
        }
        
        .btn-delete {
            background: #f44336;
            color: white;
        }
        
        .btn-edit:hover { background: #5568d3; }
        .btn-delete:hover { background: #da190b; }
        
        .empty-state {
            text-align: center;
            padding: 3em;
            color: #999;
            grid-column: 1 / -1;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
            overflow-y: auto;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            padding: 2em;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            margin: 2em;
        }
        
        .modal-content h2 {
            margin-bottom: 1.5em;
            color: #333;
        }
        
        .form-group {
            margin-bottom: 1.5em;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5em;
            color: #333;
            font-weight: 600;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 0.8em;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-family: inherit;
        }
        
        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .modal-buttons {
            display: flex;
            gap: 0.5em;
            justify-content: flex-end;
            margin-top: 2em;
        }
    </style>
</head>
<body>
    <div class="navbar">
        <h1>ğŸ“œ MASKIT - ì •ì±… ê´€ë¦¬</h1>
        <div class="user-info">
            <span id="userName"></span>
            <button onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
    </div>
    
    <div class="container">
        <div class="menu">
            <button onclick="location.href='../dashboard-policy.html'">ëŒ€ì‹œë³´ë“œ</button>
            <button class="active">ì •ì±… ê´€ë¦¬</button>
            <button onclick="location.href='entity-management.html'">ì—”í‹°í‹° ê´€ë¦¬</button>
            <button onclick="location.href='dlp-statistics.html'">DLP í†µê³„</button>
            <button onclick="location.href='decision-logs.html'">ìŠ¹ì¸/ë°˜ë ¤ ë¡œê·¸</button>
        </div>
        
        <div class="action-bar">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="ì •ì±… ì´ë¦„ ë˜ëŠ” ì„¤ëª…ìœ¼ë¡œ ê²€ìƒ‰..." onkeyup="searchPolicies()">
            </div>
            <button class="btn-add" onclick="openCreateModal()">
                â• ìƒˆ ì •ì±… ì¶”ê°€
            </button>
        </div>
        
        <div class="policy-grid" id="policyGrid">
            <div class="empty-state">ì •ì±…ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        </div>
    </div>
    
    <!-- ì •ì±… ìƒì„±/ìˆ˜ì • ëª¨ë‹¬ -->
    <div class="modal" id="policyModal">
        <div class="modal-content">
            <h2 id="modalTitle">ìƒˆ ì •ì±… ì¶”ê°€</h2>
            <form id="policyForm">
                <div class="form-group">
                    <label for="policyName">ì •ì±… ì´ë¦„ *</label>
                    <input type="text" id="policyName" required placeholder="ì˜ˆ: ê°œì¸ì •ë³´ ë³´í˜¸ ì •ì±…">
                </div>
                
                <div class="form-group">
                    <label for="policyType">ì •ì±… ìœ í˜• *</label>
                    <select id="policyType" required>
                        <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                        <option value="dlp">DLP (Data Loss Prevention)</option>
                        <option value="approval">ìŠ¹ì¸ ì •ì±…</option>
                        <option value="masking">ë§ˆìŠ¤í‚¹ ì •ì±…</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="policyDescription">ì„¤ëª… *</label>
                    <textarea id="policyDescription" required placeholder="ì •ì±…ì— ëŒ€í•œ ìƒì„¸ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="policyRules">ê·œì¹™ (JSON í˜•ì‹)</label>
                    <textarea id="policyRules" placeholder='{"keywords": ["ë¹„ë°€", "ê¸°ë°€"], "action": "block"}'></textarea>
                </div>
                
                <div class="modal-buttons">
                    <button type="button" class="btn-delete" onclick="closePolicyModal()">ì·¨ì†Œ</button>
                    <button type="submit" class="btn-add">ì €ì¥</button>
                </div>
            </form>
        </div>
    </div>
    
    <script>
        const API_BASE = 'http://127.0.0.1:8001';
        const token = localStorage.getItem('token');
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        let allPolicies = [];
        let editingPolicyId = null;
        
        if (!token || user.role !== 'policy_admin') {
            alert('ì •ì±… ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤');
            window.location.href = '../login.html';
        }
        
        document.getElementById('userName').textContent = user.nickname || user.email;
        
        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = '../login.html';
        }
        
        async function loadPolicies() {
            const grid = document.getElementById('policyGrid');
            grid.innerHTML = '<div class="empty-state">ì •ì±…ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
            
            try {
                const response = await fetch(`${API_BASE}/api/v1/policies`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    allPolicies = await response.json();
                    displayPolicies(allPolicies);
                } else {
                    grid.innerHTML = '<div class="empty-state">âŒ ì •ì±…ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</div>';
                }
            } catch (error) {
                console.error('Error:', error);
                grid.innerHTML = '<div class="empty-state">âŒ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</div>';
            }
        }
        
        function displayPolicies(policies) {
            const grid = document.getElementById('policyGrid');
            
            if (policies.length === 0) {
                grid.innerHTML = '<div class="empty-state">ë“±ë¡ëœ ì •ì±…ì´ ì—†ìŠµë‹ˆë‹¤. ìƒˆ ì •ì±…ì„ ì¶”ê°€í•´ë³´ì„¸ìš”!</div>';
                return;
            }
            
            const typeNames = {
                'dlp': 'DLP',
                'approval': 'ìŠ¹ì¸',
                'masking': 'ë§ˆìŠ¤í‚¹'
            };
            
            grid.innerHTML = policies.map(policy => {
                const createdDate = new Date(policy.created_at).toLocaleDateString('ko-KR');
                
                return `
                    <div class="policy-card">
                        <div class="policy-header">
                            <div>
                                <div class="policy-title">${policy.name}</div>
                                <span class="policy-type type-${policy.type}">${typeNames[policy.type] || policy.type}</span>
                            </div>
                        </div>
                        <div class="policy-description">${policy.description}</div>
                        <div class="policy-meta">
                            ìƒì„±ì¼: ${createdDate}<br>
                            ìƒì„±ì: ${policy.created_by || 'Unknown'}
                        </div>
                        <div class="policy-actions">
                            <button class="btn-edit" onclick="editPolicy('${policy._id}')">
                                âœï¸ ìˆ˜ì •
                            </button>
                            <button class="btn-delete" onclick="deletePolicy('${policy._id}', '${policy.name}')">
                                ğŸ—‘ï¸
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function searchPolicies() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            
            if (!query) {
                displayPolicies(allPolicies);
                return;
            }
            
            const filtered = allPolicies.filter(policy => 
                policy.name.toLowerCase().includes(query) ||
                policy.description.toLowerCase().includes(query)
            );
            
            displayPolicies(filtered);
        }
        
        function openCreateModal() {
            editingPolicyId = null;
            document.getElementById('modalTitle').textContent = 'ìƒˆ ì •ì±… ì¶”ê°€';
            document.getElementById('policyForm').reset();
            document.getElementById('policyModal').classList.add('active');
        }
        
        function editPolicy(policyId) {
            const policy = allPolicies.find(p => p._id === policyId);
            if (!policy) return;
            
            editingPolicyId = policyId;
            document.getElementById('modalTitle').textContent = 'ì •ì±… ìˆ˜ì •';
            document.getElementById('policyName').value = policy.name;
            document.getElementById('policyType').value = policy.type;
            document.getElementById('policyDescription').value = policy.description;
            document.getElementById('policyRules').value = policy.rules ? JSON.stringify(policy.rules, null, 2) : '';
            document.getElementById('policyModal').classList.add('active');
        }
        
        function closePolicyModal() {
            editingPolicyId = null;
            document.getElementById('policyModal').classList.remove('active');
            document.getElementById('policyForm').reset();
        }
        
        document.getElementById('policyForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const data = {
                name: document.getElementById('policyName').value,
                type: document.getElementById('policyType').value,
                description: document.getElementById('policyDescription').value,
                rules: document.getElementById('policyRules').value ? 
                    JSON.parse(document.getElementById('policyRules').value) : null
            };
            
            try {
                const url = editingPolicyId 
                    ? `${API_BASE}/api/v1/policies/${editingPolicyId}`
                    : `${API_BASE}/api/v1/policies`;
                
                const method = editingPolicyId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    alert(editingPolicyId ? 'âœ… ì •ì±…ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤' : 'âœ… ì •ì±…ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤');
                    closePolicyModal();
                    loadPolicies();
                } else {
                    const result = await response.json();
                    alert('âŒ ì‹¤íŒ¨: ' + (result.detail || 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤'));
                }
            } catch (error) {
                alert('âŒ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
                console.error('Error:', error);
            }
        });
        
        async function deletePolicy(policyId, policyName) {
            if (!confirm(`"${policyName}" ì •ì±…ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/v1/policies/${policyId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    alert('âœ… ì •ì±…ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
                    loadPolicies();
                } else {
                    const result = await response.json();
                    alert('âŒ ì‚­ì œ ì‹¤íŒ¨: ' + (result.detail || 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤'));
                }
            } catch (error) {
                alert('âŒ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
                console.error('Error:', error);
            }
        }
        
        loadPolicies();
    </script>
</body>
</html>